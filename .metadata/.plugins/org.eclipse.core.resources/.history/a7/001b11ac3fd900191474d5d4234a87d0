package com.bridgelabz.dao;

import java.util.List;

import javax.persistence.EntityManager;

import org.hibernate.Session;
import org.jboss.logging.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.bcrypt.BCrypt;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.bridgelabz.model.UserDetailsForRegistration;

@Repository
public class UserDaoImpl implements UserDao {
	
	Logger logger=logger.getLogger(this.getClass());
	private EntityManager entityManager;

	@Autowired
	public void setEntityManager(EntityManager entityManager) {
		this.entityManager = entityManager;
	}

	
	@Autowired
	BCrypt bcryptEncoder;

	@Transactional
	public List<UserDetailsForRegistration> retriveUserDetails() {
		Session currentSession = entityManager.unwrap(Session.class);
		List<UserDetailsForRegistration> users = currentSession.createQuery("from UserDetailsForRegistration")
				.getResultList();
		return users;
	}

	@Transactional
	public void deletFromDatabase(Integer userid) {
		Session currentSession = entityManager.unwrap(Session.class);
		currentSession.createQuery("delete from UserDetailsForRegistration where id='" + userid + "'").executeUpdate();
	}
	@Transactional
	public List<UserDetailsForRegistration> checkPassword(Integer userid) {
		Session currentSession = entityManager.unwrap(Session.class);
		List<UserDetailsForRegistration> users=currentSession.createQuery("from UserDetailsForRegistration where id='" + userid + "'").getResultList();
		for(UserDetailsForRegistration details:users) {
			String password=details.getPassword();
			if(bcryptEncoder.checkpw("1234567", password))
			{
				System.out.println("true");
			}
		}
		return users;
	}
	
	@Transactional
	public int setToDatabase(UserDetailsForRegistration userDetails) {
		Session currentSession = entityManager.unwrap(Session.class);
/*int insertion = currentSession.createQuery("insert into UserDetailsForRegistration ('"
				+ userDetails.getFirstName() + "','" + userDetails.getLastName() + "','" + userDetails.getMobileNumber()
				+ "','" + userDetails.getEmail() + "','" + userDetails.getGender() + "')").executeUpdate();
		return insertion;*/
		
		currentSession.save(userDetails);
		return 1;
	}
	@Transactional
	public int updateMobileNumberToDatabase(Integer id, UserDetailsForRegistration userDetails) {
		Session currentSession = entityManager.unwrap(Session.class);
		System.out.println(id+"in userdao");
		 return currentSession.createQuery("update UserDetailsForRegistration set mobileNumber='"+ userDetails.getMobileNumber() +"'where id='"+ id +"'").executeUpdate();
     			
	}
}